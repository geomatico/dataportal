<!DOCTYPE html>
<html>
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
		<title>ICOS Carbon Data Portal</title>
		<link rel="shortcut icon" href="img/icos.ico" />
		<link rel="stylesheet" type="text/css" href="js/ext3/resources/css/ext-all-notheme.css" />
		<link rel="stylesheet" type="text/css" href="js/ext3/resources/css/xtheme-gray.css" />
		<link rel="stylesheet" type="text/css" href="css/icos.css" />
		<script type="text/javascript" src="js/openlayers/OpenLayers.js"></script>
		<script type="text/javascript" src="js/ext3/adapter/ext/ext-base.js"></script>
		<script type="text/javascript" src="js/ext3/ext-all-debug-w-comments.js"></script>
		<script type="text/javascript" src="js/GeoExt/lib/GeoExt.js"></script>
		<script type="text/javascript">
		var viewport;
		
	    Ext.onReady(function(){
	        //Ext.state.Manager.setProvider(new Ext.state.CookieProvider());

	        vl = new OpenLayers.Layer.Vector("BBOX filters");
            bounds = OpenLayers.Bounds.fromArray([1, 38, 5, 41]);
            bounds.transform(new OpenLayers.Projection("EPSG:4326"), new OpenLayers.Projection("EPSG:900913")); // TODO: This should be put in layer or map
            box = new OpenLayers.Feature.Vector(bounds.toGeometry());
            vl.addFeatures([box]);
	        
	        Ext.QuickTips.init();
                   
	        viewport = new Ext.Viewport({
	            layout: 'border',
	            items: [{
                    region: 'north',
	                xtype: 'box',
	                height: 64,
                    contentEl: 'header'
	            }, {
	                region: 'south',
	                contentEl: 'log',
	                split: true,
	                height: 100,
	                minSize: 100,
	                maxSize: 200,
	                collapsible: true,
	                autoScroll: true,
	                title: 'Message Log',
	                margins: '0 0 0 0'
	            }, {
                    region: 'east',
	                title: 'User',
	                layout: 'fit',
					collapsible: true,
	                split: true,
	                width: 225,
	                minSize: 175,
	                maxSize: 400,
	                margins: '0 5 0 0',
	                items: [{
	                    xtype: 'tabpanel',
	                    border: false,
	                    activeTab: 0,
	                    items: [{
	                        title: 'Shopping Cart',
	                        html: '<p>Dataset bundle download manager & QI generator</p>',
	                        autoScroll: true
	                    }, {
	                        title: 'Settings',
	                        html: '<p>Change personal preferences and data</p>',
	                        autoScroll: true
	                    }]
	                }]
	            }, {
	                region: 'west',
	                id: 'west-panel',
	                title: 'Query Panel',
	                split: false,
	                width: 287,
	                collapsible: true,
	                margins: '0 0 0 5',
	                layout: {
	                    type: 'vbox',
	                    align:'stretch',
	                    animate: true
	                },
	                items: [{
	                    labelAlign: 'top',
	                    autoScroll: true,
	                    border: true,
	                    padding: 4,
		                flex: 1,
	                    xtype: 'form',
	                    labelWidth: 60,
	                    id: 'searchFormPanel',
	                    items: [/*{
                            fieldLabel: 'Text',
	                        xtype: 'textfield',
                            name: 'textfield',
                            value: ''
                        },*/ {
                            xtype: 'gx_mappanel',
                            map: {
                                controls: [new OpenLayers.Control.Navigation()]
                            },
                            layers: [new OpenLayers.Layer.OSM("Base Layer"), vl],
                            zoom: 0,
                            height: 297,
                            tbar: [{
                                xtype: 'tbtext',
                                text: 'Filter by location:'
                            }, "->", {
                                xtype: 'tbbutton',
                                qtip: 'Navigate',
                                iconCls: 'mapNav',
                                handler: function(btn) {
                                    log(btn.qtip+" Button Pressed");
                                }
                            }, {
                                xtype: 'tbbutton',
                                qtip: 'Add filter',
                                iconCls: 'bboxAdd',
                                handler: function(btn) {
                                    log(btn.qtip+" Button Pressed");
                                }
                            }, {
                                xtype: 'tbbutton',
                                qtip: 'Remove filter',
                                iconCls: 'bboxDel',
                                handler: function(btn) {
                                    log(btn.qtip+" Button Pressed");
                                }
                            }/*, {
                                xtype: 'tbbutton',
                                qtip: 'Open bigger map',
                                iconCls: 'mapBig',
                                handler: function(btn) {
                                    log(btn.qtip+" Button Pressed");
                                }
                            }*/]
                        }, {
                            xtype: 'container',
                            layout: 'column',
                            items: [{
                                type: 'form',
                                labelAlign: 'top',
                                border: false,
                                columnWidth: 0.5,                                
                                items: [{
		                            xtype: 'datefield',
		                            name: 'from_date',
		                            fieldLabel: 'From date'
                                }]
	                        }, {
                                type: 'form',
                                labelAlign: 'top',
	                            border: false,
                                columnWidth: 0.5,
	                            items: [{
		                            xtype: 'datefield',
		                            name: 'to_date',
		                            fieldLabel: 'To date'
	                            }]
	                        }]
                        }, {
                            xtype: 'checkboxgroup',
                            fieldLabel: 'Magnitudes',
                           	columns: 2,
                           	id: 'magnitudes',
                               items: [ // TODO: Generate items from datasource
                                   {boxLabel: 'Temperature', name: 'sea_water_temp'},
                                   {boxLabel: 'Salinity', name: 'sea_water_salinity'},  
                                   {boxLabel: 'Fluor', name: 'fuor_kin_dientes_sanos'},  
                                   {boxLabel: '[...]', name: 'other_stuff'}
                               ]
                        }],
                        buttons: [{
                            text: 'Search',
                            handler: function() {
                                var format = new OpenLayers.Format.WKT({ // TODO: Make a simpler serializer for BBOXes
                                    internalProjection: new OpenLayers.Projection("EPSG:900913"),
                                    externalProjection: new OpenLayers.Projection("EPSG:4326")
                                });
                                
                                Ext.getCmp('searchFormPanel').getForm().submit({
                                    url: this.url,
                                    scope: this,
                                    success: function() {log('Search query: success')},
                                    failure: function() {log('Search qyery: failure')},
                                    params: {
                                        bboxes: format.write(vl.features, false),
                                    },
                                    //method: 'GET',
                                    waitMsg: 'Querying...'
                                });
                            }
                        }],
                        //standardSubmit: true,
                        url: 'sarch_servlet' // TODO: Put the search servlet query here
	                }, {
	                	title: 'Get data by Query Identifier',
	                	border: false,
	                	height: 100,
	                	padding: 10,
	                	xtype: 'form',
                        items: [{
                            xtype: 'textfield',
                            name: 'qi_field',
                            fieldLabel: 'DOI',
                            value: ''
                        }],
                        buttons: [{
                            text: 'Get dataset',
                            handler: function(a, b) {
                                log("Search by QI button pressed");
                            }
                        }]
	                }]
	            }, {
	                xtype: 'tabpanel',
	                region: 'center',
	                deferredRender: false,
	                activeTab: 0,
	                items: [{
	                    contentEl: 'results',
	                    title: 'Results',
	                    closable: false,
	                    autoScroll: true
	                },{
	                    contentEl: 'other',
	                    title: 'Other Views',
	                    closable: true,
	                    autoScroll: true
	                }]
	            }]
	        });
	        log("Layout Loaded");
	    });
	    
	    function log(message) {
	    	Ext.fly("log").dom.innerHTML = "[" + new Date().format('Y-m-d H:i:s') + "] <b>"+message+"</b><br>" + Ext.fly("log").dom.innerHTML;
	    }
	    
		</script>
	</head>
	<body>
		<div id="header" class="x-hide-display">
			 <img src="img/icos-logo.png"/>
			 <div id="title">ICOS Carbon Data Portal</div>
			 <a href="#" class="login" onclick="log('Login clicked')">Login</a>
		</div>
	    <!-- use class="x-hide-display" to prevent a brief flicker of the content -->
	    <div id="search" class="x-hide-display">
	        <p>Search form</p>
	    </div>
	    <div id="results" class="x-hide-display">
	        <p><b>Result grid renders here</b></p>
	    </div>
	    <div id="other" class="x-hide-display">
	        <p><b>Close me</b></p>
	    </div>
	    <div id="log" class="x-hide-display" style="font-family:monospace;">
	    </div>
    </body>
</html>
