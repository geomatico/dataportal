<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
    <head>
       <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
       <title>ICOS Carbon Data Portal - Usage Reports</title>
       <link rel="shortcut icon" href="img/icos.ico" />
       <link rel="stylesheet" type="text/css" href="js/ext3/resources/css/ext-all-notheme.css" />
       <link rel="stylesheet" type="text/css" href="js/ext3/resources/css/xtheme-gray.css" />
       <link rel="stylesheet" type="text/css" href="css/dataportal.css" />
       <script type="text/javascript" src="js/ext3/adapter/ext/ext-base-debug.js"></script>
       <script type="text/javascript" src="js/ext3/ext-all-debug-w-comments.js"></script>
<script>

Ext.onReady(function(){
    
    /* Downloads by Institution */
    var downloadsByInstitutionStore = new Ext.data.JsonStore({
        fields: ["institution", "downloads"]
    });
   
    var piePanel = new Ext.Panel({
        title: "Downloads by Institution",
        items: [new Ext.chart.PieChart({
            store: downloadsByInstitutionStore,
            categoryField: "institution",
            dataField: "downloads",
            tipRenderer: function(chart, record, index, series) {
                return record.data.institution + ": " + record.data.downloads + " downloads.";
            },
            extraStyle: {
                legend:{
                    display: 'right',
                    padding: 10,
                    border: {
                        color: '#CBCBCB',
                        size: 1
                    }
                }
            }
        })]
    });
    
    /* Downloads by Domain */
    var downloadsByDomainStore = new Ext.data.JsonStore({
        fields: ["domain", "downloads"]
    });

    var columnPanel = new Ext.Panel({
        title: "Downloads by Domain",
        items: [new Ext.chart.ColumnChart({
            store: downloadsByDomainStore,
            xField: "domain",
            yField: "downloads",
            tipRenderer: function(chart, record, index, series) {
                return record.data.domain + ": " + record.data.downloads + " downloads.";
            },
            xAxis: new Ext.chart.CategoryAxis({
                title: "Domain"
            }),
            yAxis: new Ext.chart.NumericAxis({
                title: "Downloads"
            })
        })]
    });
    
    /* Downloads By Date */
    var downloadsByDateStore = new Ext.data.JsonStore({
        fields: [
            {name: "date", type: "date", convert: conv},
            "downloads"
        ]
    });
	
    function conv(v, record) {
        return new Date(2011, 11, record.date);
    }
    
    var lineChart = new Ext.chart.LineChart({
        store: downloadsByDateStore,
        xField: "date",
        yField: "downloads",
        yAxis: new Ext.chart.NumericAxis({
            title: 'Downloads'
        })
    });
    
	var linePanel = new Ext.Panel({
	    title: 'Downloads by Date',
	    items: [lineChart]
	});

	/* Combo Values */
	// Year ranges from current year back to 2011.
	var years = [];
	for (v = new Date().format('Y'); v >= 2011; years.push(v--));
	
	// Month names from 1 to 12, plus "all year round" = 0 value.
	var months = [[0, "-All- (Yearly Report)"]];
	Ext.each(Date.monthNames, function(month, index) {
	    months[index+1] = [index+1, month];
	});

	var form = new Ext.form.FormPanel({
        labelAlign: 'top',
        autoScroll: true,
        height: 155,
        border: true,
        padding: 4,
        defaults: {
            editable: false,
            triggerAction: 'all',
            mode: 'local'            
        },
        items: [
            new Ext.form.ComboBox({
                fieldLabel: 'Year',
                id: 'year',
                hiddenName: 'year',
                value: new Date().format('Y'),
                store: years
            }),
            new Ext.form.ComboBox({
                fieldLabel: 'Month',
                id: 'month',
                hiddenName: 'month',
                value: new Date().format('n'),
                store: months
            })
        ],
        buttons: [{
            text: 'Generate report >>',
            handler: function(button, event) {
                
                // Get data; 3 requests to "report" service:    
                form.getForm().submit({
                    url: 'report',
                    params: { request: "GetDownloadsByDate" },
                    success: function(form, action) {
                        downloadsByDateStore.loadData(action.result.data);
                    },
                    failure: function(form, action) {
                        alert(action.result.message);
                    }
                });

                form.getForm().submit({
                    url: 'report',
                    params: { request: "GetDownloadsByDomain" },
                    success: function(form, action) {
                        downloadsByDomainStore.loadData(action.result.data);
                    },
                    failure: failure
                });
                
                form.getForm().submit({
                    url: 'report',
                    params: { request: "GetDownloadsByInstitution" },
                    success: function(form, action) {
                        downloadsByInstitutionStore.loadData(action.result.data);
                    },
                    failure: failure
                });
                
                // Change report title and "Downloads by Date" horizontal range                
                var year = Ext.getCmp("year").getValue();
                var month = Ext.getCmp("month").getValue();
                var period;
                
                if (month > 0) {
                    // Monthly report
                    period = Ext.getCmp("month").getRawValue() + " " + year;
                    lineChart.setTipRenderer(function(chart, record, index, series) {
                        return record.data.date.format("M j, Y") + ": " + record.data.downloads + " downloads.";
                    });
                    lineChart.setXAxis(new Ext.chart.TimeAxis({
                        title: new Date(year, month-1, 1).format("F Y"),
                        minimum: new Date(year, month-1, 1),
                        maximum: new Date(year, month, 0),
                        labelRenderer: function(date) { return date.format("j"); } // Days in a month
                    }));
                } else {
                    // Yearly report
                    period = "Year " + year;
                    lineChart.setTipRenderer(function(chart, record, index, series) {
                        return record.data.date.format("M Y") + ": " + record.data.downloads + " downloads.";
                    });
                    lineChart.setXAxis(new Ext.chart.TimeAxis({
                        title: new Date(year, 0, 1).format("Y"),
                        minimum: new Date(year, 0, 1),
                        maximum: new Date(year, 11, 31),
                        labelRenderer: function(date) { return date.format("M"); } // Months in a yeaar
                    }));
                }
                Ext.get("period").update(period);
            }
        }]
    })
	
   var failure = function(form, action) {
        Ext.Msg.alert('Failure', action.result.message);
    };

	new Ext.Viewport({
	    layout: 'border',
	    items:[{
	        region: 'north',
	        html: '<div id="header"><img src="img/icos-logo.png"/><div id="title"><span id="period"></span> Usage Report</div></div>'
	    },{
		    region: 'center',
		    autoScroll: true,
		    defaults: {
		        height:250,
		        width:600,
		        collapsible: true,
		        border: true,
		        titleCollapse: true
		    },
		    items: [piePanel, columnPanel, linePanel]
		},{
		    region: 'west',
		    width: 200,
		    items: [form]
		}]
	});

});
</script>
</head>
<body>
</body>
</html>